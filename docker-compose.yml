version: '3.8'

services:
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: efayda-bot
    restart: unless-stopped
    depends_on:
      - mongodb
      - redis
    environment:
      - NODE_ENV=production
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - MONGODB_URI=mongodb://mongodb:27017/efayda
      - REDIS_URI=redis://redis:6379
      - TELEBIRR_RECEIVER_PHONE=${TELEBIRR_RECEIVER_PHONE}
      - CBE_RECEIVER_ACCOUNT=${CBE_RECEIVER_ACCOUNT}
      - PAYMENT_RECIPIENT_NAME=${PAYMENT_RECIPIENT_NAME}
      - SERVICE_PRICE=${SERVICE_PRICE:-50}
      - TEMP_DIR=/app/temp
      - LOG_LEVEL=info
      - SUPPORT_CONTACT=${SUPPORT_CONTACT:-@efayda_support}
    volumes:
      - bot-temp:/app/temp
    networks:
      - efayda-network

  mongodb:
    image: mongo:6
    container_name: efayda-mongodb
    restart: unless-stopped
    volumes:
      - mongodb-data:/data/db
    networks:
      - efayda-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: efayda-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    networks:
      - efayda-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  mongodb-data:
  redis-data:
  bot-temp:

networks:
  efayda-network:
    driver: bridge
